<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Architecture — ANN Documentation</title>
  <link rel="stylesheet" href="style.css">
  <script>document.addEventListener('DOMContentLoaded',()=>{document.querySelector('.hamburger')?.addEventListener('click',()=>{document.querySelector('.sidebar').classList.toggle('open')})});</script>
</head>
<body>
<header class="site-header">
  <button class="hamburger" aria-label="Menu">☰</button>
  <h1>ANN</h1><span class="subtitle">Artificial Neural Network Library</span>
</header>
<div class="layout">
<aside class="sidebar"><nav>
  <div class="section-title">Getting Started</div>
  <a href="index.html">Home</a>
  <a href="quickstart.html">Quick Start &amp; Build</a>
  <a href="examples.html">Code Examples</a>
  <div class="section-title">Reference</div>
  <a href="api.html">API Reference</a>
  <a href="architecture.html" class="active">Architecture</a>
  <div class="section-title">Deep Dive</div>
  <a href="math.html">Mathematical Foundations</a>
  <a href="gpu.html">GPU Implementation</a>
</nav></aside>
<main class="main">

<h1>Architecture</h1>

<div class="toc">
  <h4>On this page</h4>
  <ol>
    <li><a href="#hierarchy">Class Hierarchy</a></li>
    <li><a href="#patterns">Design Patterns</a></li>
    <li><a href="#dataflow">Data Flow</a></li>
    <li><a href="#training">Training Loop</a></li>
    <li><a href="#threading">Threading Model</a></li>
    <li><a href="#memory">Memory Layout</a></li>
  </ol>
</div>

<h2 id="hierarchy">1. Class Hierarchy</h2>

<figure class="diagram">
<svg viewBox="0 0 700 320" xmlns="http://www.w3.org/2000/svg" font-family="system-ui,sans-serif" font-size="14">
  <!-- Core base -->
  <rect x="250" y="10" width="200" height="50" rx="8" fill="#e8f0fe" stroke="#1a73e8" stroke-width="2"/>
  <text x="350" y="30" text-anchor="middle" font-weight="700" fill="#1a73e8">Core&lt;T&gt;</text>
  <text x="350" y="48" text-anchor="middle" font-size="11" fill="#5f6368">Abstract Base Class</text>

  <!-- Lines down -->
  <line x1="300" y1="60" x2="175" y2="100" stroke="#dadce0" stroke-width="2"/>
  <line x1="400" y1="60" x2="525" y2="100" stroke="#dadce0" stroke-width="2"/>

  <!-- CoreCPU -->
  <rect x="75" y="100" width="200" height="50" rx="8" fill="#e6f4ea" stroke="#34a853" stroke-width="2"/>
  <text x="175" y="120" text-anchor="middle" font-weight="700" fill="#137333">CoreCPU&lt;T&gt;</text>
  <text x="175" y="138" text-anchor="middle" font-size="11" fill="#5f6368">Multi-threaded CPU</text>

  <!-- CoreGPU -->
  <rect x="425" y="100" width="200" height="50" rx="8" fill="#fef7e0" stroke="#f9ab00" stroke-width="2"/>
  <text x="525" y="120" text-anchor="middle" font-weight="700" fill="#b06000">CoreGPU&lt;T&gt;</text>
  <text x="525" y="138" text-anchor="middle" font-size="11" fill="#5f6368">Multi-GPU Orchestrator</text>

  <!-- Line to worker -->
  <line x1="525" y1="150" x2="525" y2="190" stroke="#dadce0" stroke-width="2"/>

  <!-- CoreGPUWorker -->
  <rect x="400" y="190" width="250" height="50" rx="8" fill="#fce8e6" stroke="#c5221f" stroke-width="2"/>
  <text x="525" y="210" text-anchor="middle" font-weight="700" fill="#c5221f">CoreGPUWorker&lt;T&gt;</text>
  <text x="525" y="228" text-anchor="middle" font-size="11" fill="#5f6368">One per physical GPU</text>

  <!-- SampleWorker -->
  <line x1="175" y1="150" x2="175" y2="190" stroke="#dadce0" stroke-width="2"/>
  <rect x="50" y="190" width="250" height="50" rx="8" fill="#f1f3f4" stroke="#dadce0" stroke-width="2"/>
  <text x="175" y="210" text-anchor="middle" font-weight="600" fill="#202124">SampleWorker&lt;T&gt;</text>
  <text x="175" y="228" text-anchor="middle" font-size="11" fill="#5f6368">Thread-local state (struct)</text>

  <!-- Helpers -->
  <rect x="250" y="270" width="200" height="40" rx="8" fill="#f1f3f4" stroke="#dadce0" stroke-width="2"/>
  <text x="350" y="295" text-anchor="middle" font-weight="600" fill="#202124">ActvFunc · Utils&lt;T&gt; (helpers)</text>
</svg>
<figcaption>Figure 1 — Core class hierarchy. Arrows indicate inheritance.</figcaption>
</figure>

<h2 id="patterns">2. Design Patterns</h2>

<div class="card">
<h3>Factory Pattern</h3>
<p><code>Core&lt;T&gt;::makeCore(config)</code> inspects <code>config.deviceType</code> and returns either a <code>CoreCPU&lt;T&gt;</code> or <code>CoreGPU&lt;T&gt;</code> wrapped in a <code>std::unique_ptr</code>. Callers never need to know which implementation they're using.</p>
</div>

<div class="card">
<h3>Template Method</h3>
<p>The base class defines the high-level training algorithm (timing, metadata, callback dispatch), while subclasses (<code>CoreCPU</code>, <code>CoreGPU</code>) implement the actual computation. Protected helpers like <code>calculateLoss()</code>, <code>trainingStart()</code>, and <code>trainingEnd()</code> are shared.</p>
</div>

<div class="card">
<h3>Strategy Pattern</h3>
<p>The CPU and GPU implementations are interchangeable strategies for the same interface. The activation function dispatch (<code>ActvFunc::calculate</code>) also follows this pattern, selecting the right formula at runtime based on the <code>ActvFuncType</code> enum.</p>
</div>

<div class="card">
<h3>Lazy Initialisation</h3>
<p>GPU kernels are compiled only on first use. <code>CoreGPUWorker</code> tracks boolean flags (<code>predictKernelsSetup</code>, <code>trainingKernelsSetup</code>) and builds the appropriate kernel pipeline when a method is first called.</p>
</div>

<div class="card">
<h3>Callback Pattern</h3>
<p>Training progress is reported via <code>TrainingCallback&lt;T&gt;</code> — a <code>std::function</code> that receives a <code>TrainingProgress&lt;T&gt;</code> struct. The CLI and GUI can attach their own handlers.</p>
</div>

<h2 id="dataflow">3. Data Flow</h2>

<figure class="diagram">
<svg viewBox="0 0 700 160" xmlns="http://www.w3.org/2000/svg" font-family="system-ui,sans-serif" font-size="13">
  <defs>
    <marker id="arr" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#1a73e8"/></marker>
  </defs>
  <!-- Input -->
  <rect x="10" y="55" width="100" height="40" rx="6" fill="#e8f0fe" stroke="#1a73e8" stroke-width="1.5"/>
  <text x="60" y="80" text-anchor="middle" font-weight="600" fill="#1a73e8">Input&lt;T&gt;</text>
  <!-- Arrow -->
  <line x1="110" y1="75" x2="145" y2="75" stroke="#1a73e8" stroke-width="1.5" marker-end="url(#arr)"/>
  <!-- Layer 0 -->
  <rect x="150" y="40" width="90" height="70" rx="6" fill="#e6f4ea" stroke="#34a853" stroke-width="1.5"/>
  <text x="195" y="68" text-anchor="middle" font-weight="600" font-size="12" fill="#137333">Layer 0</text>
  <text x="195" y="85" text-anchor="middle" font-size="10" fill="#5f6368">z = Wa + b</text>
  <text x="195" y="100" text-anchor="middle" font-size="10" fill="#5f6368">a = f(z)</text>
  <!-- Arrow -->
  <line x1="240" y1="75" x2="275" y2="75" stroke="#1a73e8" stroke-width="1.5" marker-end="url(#arr)"/>
  <!-- Layer 1 -->
  <rect x="280" y="40" width="90" height="70" rx="6" fill="#e6f4ea" stroke="#34a853" stroke-width="1.5"/>
  <text x="325" y="68" text-anchor="middle" font-weight="600" font-size="12" fill="#137333">Layer 1</text>
  <text x="325" y="85" text-anchor="middle" font-size="10" fill="#5f6368">z = Wa + b</text>
  <text x="325" y="100" text-anchor="middle" font-size="10" fill="#5f6368">a = f(z)</text>
  <!-- dots -->
  <text x="395" y="80" text-anchor="middle" font-size="20" fill="#5f6368">…</text>
  <!-- Layer L -->
  <rect x="420" y="40" width="90" height="70" rx="6" fill="#e6f4ea" stroke="#34a853" stroke-width="1.5"/>
  <text x="465" y="68" text-anchor="middle" font-weight="600" font-size="12" fill="#137333">Layer L</text>
  <text x="465" y="85" text-anchor="middle" font-size="10" fill="#5f6368">z = Wa + b</text>
  <text x="465" y="100" text-anchor="middle" font-size="10" fill="#5f6368">a = f(z)</text>
  <!-- Arrow -->
  <line x1="510" y1="75" x2="545" y2="75" stroke="#1a73e8" stroke-width="1.5" marker-end="url(#arr)"/>
  <!-- Output -->
  <rect x="550" y="55" width="110" height="40" rx="6" fill="#fef7e0" stroke="#f9ab00" stroke-width="1.5"/>
  <text x="605" y="80" text-anchor="middle" font-weight="600" fill="#b06000">Output&lt;T&gt;</text>
  <!-- Backprop arrow -->
  <line x1="545" y1="130" x2="115" y2="130" stroke="#c5221f" stroke-width="1.5" marker-end="url(#arr)" stroke-dasharray="6,3"/>
  <text x="330" y="148" text-anchor="middle" font-size="11" fill="#c5221f">← Backpropagation (gradients)</text>
</svg>
<figcaption>Figure 2 — Forward (solid) and backward (dashed) data flow through the network.</figcaption>
</figure>

<h2 id="training">4. Training Loop</h2>
<p>The high-level training algorithm (implemented differently in CPU vs GPU):</p>

<pre><code><span class="keyword">for</span> epoch = <span class="number">1</span> <span class="keyword">to</span> numEpochs:
    <span class="func">resetAccumulators</span>()

    <span class="keyword">for each</span> sample <span class="keyword">in</span> shuffled(samples):
        <span class="comment">// 1. Forward pass</span>
        output = <span class="func">predict</span>(sample.input)

        <span class="comment">// 2. Compute loss (MSE)</span>
        loss = (<span class="number">1</span>/n) × Σ (output[i] − expected[i])²

        <span class="comment">// 3. Backward pass — compute gradients</span>
        <span class="func">backpropagate</span>(sample.output)

        <span class="comment">// 4. Add to running totals</span>
        <span class="func">accumulate</span>()

    <span class="comment">// 5. SGD weight update</span>
    <span class="func">update</span>(numSamples)
</code></pre>

<h2 id="threading">5. Threading Model (CPU)</h2>

<figure class="diagram">
<svg viewBox="0 0 700 220" xmlns="http://www.w3.org/2000/svg" font-family="system-ui,sans-serif" font-size="13">
  <!-- Main thread -->
  <rect x="250" y="10" width="200" height="36" rx="6" fill="#e8f0fe" stroke="#1a73e8" stroke-width="1.5"/>
  <text x="350" y="33" text-anchor="middle" font-weight="600" fill="#1a73e8">Main Thread</text>

  <!-- Fan out lines -->
  <line x1="290" y1="46" x2="90" y2="76" stroke="#dadce0" stroke-width="1.5"/>
  <line x1="330" y1="46" x2="260" y2="76" stroke="#dadce0" stroke-width="1.5"/>
  <line x1="370" y1="46" x2="430" y2="76" stroke="#dadce0" stroke-width="1.5"/>
  <line x1="410" y1="46" x2="600" y2="76" stroke="#dadce0" stroke-width="1.5"/>

  <!-- Worker threads -->
  <rect x="20" y="76" width="140" height="60" rx="6" fill="#e6f4ea" stroke="#34a853" stroke-width="1.5"/>
  <text x="90" y="98" text-anchor="middle" font-weight="600" font-size="12" fill="#137333">Worker 0</text>
  <text x="90" y="114" text-anchor="middle" font-size="10" fill="#5f6368">predict + backprop</text>
  <text x="90" y="128" text-anchor="middle" font-size="10" fill="#5f6368">local accumulate</text>

  <rect x="190" y="76" width="140" height="60" rx="6" fill="#e6f4ea" stroke="#34a853" stroke-width="1.5"/>
  <text x="260" y="98" text-anchor="middle" font-weight="600" font-size="12" fill="#137333">Worker 1</text>
  <text x="260" y="114" text-anchor="middle" font-size="10" fill="#5f6368">predict + backprop</text>
  <text x="260" y="128" text-anchor="middle" font-size="10" fill="#5f6368">local accumulate</text>

  <rect x="360" y="76" width="140" height="60" rx="6" fill="#e6f4ea" stroke="#34a853" stroke-width="1.5"/>
  <text x="430" y="98" text-anchor="middle" font-weight="600" font-size="12" fill="#137333">Worker 2</text>
  <text x="430" y="114" text-anchor="middle" font-size="10" fill="#5f6368">predict + backprop</text>
  <text x="430" y="128" text-anchor="middle" font-size="10" fill="#5f6368">local accumulate</text>

  <rect x="530" y="76" width="140" height="60" rx="6" fill="#e6f4ea" stroke="#34a853" stroke-width="1.5"/>
  <text x="600" y="98" text-anchor="middle" font-weight="600" font-size="12" fill="#137333">Worker N</text>
  <text x="600" y="114" text-anchor="middle" font-size="10" fill="#5f6368">predict + backprop</text>
  <text x="600" y="128" text-anchor="middle" font-size="10" fill="#5f6368">local accumulate</text>

  <!-- Merge -->
  <line x1="90" y1="136" x2="350" y2="176" stroke="#dadce0" stroke-width="1.5"/>
  <line x1="260" y1="136" x2="350" y2="176" stroke="#dadce0" stroke-width="1.5"/>
  <line x1="430" y1="136" x2="350" y2="176" stroke="#dadce0" stroke-width="1.5"/>
  <line x1="600" y1="136" x2="350" y2="176" stroke="#dadce0" stroke-width="1.5"/>

  <rect x="250" y="170" width="200" height="36" rx="6" fill="#fef7e0" stroke="#f9ab00" stroke-width="1.5"/>
  <text x="350" y="193" text-anchor="middle" font-weight="600" fill="#b06000">Merge &amp; Update</text>
</svg>
<figcaption>Figure 3 — CPU training uses <code>QtConcurrent::blockingMap</code> to fan out samples to thread-local workers, then merges accumulators.</figcaption>
</figure>

<p>Each <code>SampleWorker&lt;T&gt;</code> contains:</p>
<ul>
  <li>Private copies of <code>actvs</code> and <code>zs</code> (activations and pre-activations)</li>
  <li>Private gradient tensors (<code>dCost_dWeights</code>, <code>dCost_dBiases</code>, <code>dCost_dActvs</code>)</li>
  <li>Local accumulators (<code>accum_dCost_dWeights</code>, <code>accum_dCost_dBiases</code>, <code>accum_loss</code>)</li>
</ul>
<p>This eliminates mutex contention entirely — workers never share mutable state.</p>

<h2 id="memory">6. Memory Layout</h2>
<p>On the GPU, all multi-dimensional tensors are flattened into 1-D buffers for efficient OpenCL transfer:</p>

<div class="card">
<h3>Index Calculation</h3>
<p>Given layers with neuron counts <code>[n₀, n₁, …, nₗ]</code>:</p>
<ul>
  <li><strong>Activation index:</strong> <code>actv[l][j] → offset = Σ(n₀..n_{l-1}) + j</code></li>
  <li><strong>Weight index:</strong> <code>weight[l][j][k] → offset = Σ(n_i · n_{i-1}, i=1..l-1) + j · n_{l-1} + k</code></li>
  <li><strong>Bias index:</strong> same as activation index</li>
</ul>
<p>These calculations are performed by the <code>IdxHelper.cpp.cl</code> kernel helper functions on the GPU.</p>
</div>

</main>
</div>
<footer class="site-footer">ANN Library Documentation</footer>
</body></html>

